{% extends 'base.html' %}
{% block title %}MDcription - ≈ûifreli G√∂rseller{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center mb-4">≈ûifreli G√∂rsel Galerisi</h2>
    </div>
</div>
<div class="row">
    <div class="col-md-4">
        <h5 class="text-center mb-2">
            Kayƒ±tlƒ± G√∂rseller 
            <input type="checkbox" id="select-all-images" class="ms-2">
        </h5>
        <div class="list-group" id="image-list">
            {% for image in images %}
            <button type="button" class="list-group-item list-group-item-action" data-id="{{ image[0] }}">
                <input type="checkbox" class="form-check-input me-2 image-checkbox" data-id="{{ image[0] }}">
                ID: {{ image[0] }} - Tarih: {{ image[1] }}
            </button>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-8">
        <div class="row mb-4">
            <div class="col-md-6">
                <h5 class="text-center mb-2">≈ûifrelenmi≈ü G√∂r√ºnt√º</h5>
                <div class="image-container encrypted">
                    <img id="gallery-encrypted" src="/static/placeholder.png" alt="≈ûifrelenmi≈ü">
                </div>
            </div>
            
            <div class="col-md-6">
                <h5 class="text-center mb-2">De≈üifre Edilmi≈ü G√∂r√ºnt√º</h5>
                <div class="image-container decrypted">
                    <img id="gallery-decrypted" src="/static/placeholder.png" alt="De≈üifrelenmi≈ü">
                </div>
            </div>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-auto">
                <button id="btn-decrypt-gallery" class="btn btn-primary me-2">
                    üîì De≈üifrele
                </button>
            </div>
            <div class="col-auto">
                <button id="btn-delete-selected" class="btn btn-danger me-2">
                    üóëÔ∏è Se√ßilenleri Sil
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    let currentImageId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // T√ºm g√∂r√ºnt√ºleri se√ßme/se√ßimi kaldƒ±rma
        const selectAllCheckbox = document.getElementById('select-all-images');
        const imageCheckboxes = document.querySelectorAll('.image-checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            imageCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // G√∂rsel listesinden tƒ±klama olayƒ±
        document.querySelectorAll('#image-list .list-group-item').forEach(item => {
            item.addEventListener('click', function(e) {
                // Eƒüer checkbox'a tƒ±klanmadƒ±ysa
                if (!e.target.classList.contains('form-check-input')) {
                    // Aktif sƒ±nƒ±fƒ±nƒ± y√∂net
                    document.querySelectorAll('#image-list .list-group-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // ID'yi al
                    currentImageId = this.dataset.id;
                    
                    // Doƒürudan ≈üifreli g√∂r√ºnt√ºy√º y√ºkle
                    fetch(`/load/${currentImageId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Hemen ≈üifreli g√∂r√ºnt√ºy√º g√∂ster
                                document.getElementById('gallery-encrypted').src = '/static/uploads/' + data.encrypted;
                                // De≈üifrelenmi≈ü g√∂r√ºnt√ºy√º temizle
                                document.getElementById('gallery-decrypted').src = '/static/placeholder.png';
                            } else {
                                alert("G√∂r√ºnt√º y√ºklenemedi: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Y√ºkleme hatasƒ±:", error);
                            alert("Sunucu hatasƒ±: " + error);
                        });
                }
            });
        });
        
        // Otomatik olarak ilk g√∂r√ºnt√ºy√º se√ß - varsa
        const firstImage = document.querySelector('#image-list .list-group-item');
        if (firstImage) {
            firstImage.click();
        }
        
        // De≈üifreleme butonu
        document.getElementById('btn-decrypt-gallery').addEventListener('click', function() {
            if (!currentImageId) {
                alert("L√ºtfen √∂nce bir g√∂r√ºnt√º se√ßin.");
                return;
            }
            
            fetch(`/decrypt/${currentImageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('gallery-decrypted').src = '/static/uploads/' + data.decrypted;
                    } else {
                        alert("De≈üifreleme hatasƒ±: " + data.message);
                    }
                })
                .catch(error => {
                    console.error("De≈üifreleme hatasƒ±:", error);
                    alert("Sunucu hatasƒ±: " + error);
                });
        });
        
        // Se√ßili g√∂r√ºnt√ºleri silme butonu
        document.getElementById('btn-delete-selected').addEventListener('click', function() {
            // Se√ßili g√∂r√ºnt√ºlerin ID'lerini topla
            const selectedImageIds = Array.from(
                document.querySelectorAll('.image-checkbox:checked')
            ).map(checkbox => checkbox.dataset.id);
            
            if (selectedImageIds.length === 0) {
                alert("L√ºtfen silmek i√ßin en az bir g√∂r√ºnt√º se√ßin.");
                return;
            }
            
            if (confirm(`${selectedImageIds.length} adet g√∂r√ºnt√ºy√º silmek istediƒüinize emin misiniz?`)) {
                // Toplu silme i√ßin yeni bir endpoint ekleyin
                fetch('/delete-multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: selectedImageIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`${selectedImageIds.length} adet g√∂r√ºnt√º ba≈üarƒ±yla silindi.`);
                        // Sayfayƒ± yenile
                        window.location.reload();
                    } else {
                        alert("Silme hatasƒ±: " + data.message);
                    }
                })
                .catch(error => {
                    console.error("Silme hatasƒ±:", error);
                    alert("Sunucu hatasƒ±: " + error);
                });
            }
        });
    });
</script>
{% endblock %}