{% extends 'base.html' %}

{% block title %}MDcription - Ana Sayfa{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center mb-4">GÃ¶rÃ¼ntÃ¼ Åifreleme Sistemi</h2>
    </div>
</div>

<div class="row mb-4">
    <!-- Kamera GÃ¶rÃ¼ntÃ¼sÃ¼ -->
    <div class="col-md-6">
        <h5 class="text-center mb-2">Kamera</h5>
        <div class="image-container">
            <video id="video" autoplay></video>
        </div>
    </div>
    
    <!-- ÅifrelenmiÅŸ GÃ¶rÃ¼ntÃ¼ -->
    <div class="col-md-6">
        <h5 class="text-center mb-2">ÅifrelenmiÅŸ GÃ¶rÃ¼ntÃ¼</h5>
        <div class="image-container encrypted">
            <img id="encrypted-image" src="/static/placeholder.png" alt="ÅifrelenmiÅŸ">
        </div>
    </div>
</div>

<!-- Terminal ve Log AlanÄ± -->
<div class="row mb-4">
    <div class="col-12">
        <div class="terminal-title">Sistem Bildirim Konsolu</div>
        <div id="log-area" class="terminal">
            <div>ğŸš€ MDcription - GÃ¶rÃ¼ntÃ¼ Åifreleme Sistemi baÅŸlatÄ±ldÄ±...</div>
            <div>ğŸ“¹ Kamera aÃ§Ä±lÄ±yor ve gÃ¶rÃ¼ntÃ¼ iÅŸleme hazÄ±rlanÄ±yor...</div>
        </div>
    </div>
</div>

<!-- Butonlar -->
<div class="row mb-4 justify-content-center">
    <div class="col-auto">
        <button id="btn-capture" class="btn btn-primary me-2">
            <i class="fas fa-camera"></i> ğŸ“· GÃ¶rÃ¼ntÃ¼ Yakala
        </button>
    </div>
    <div class="col-auto">
        <button id="btn-save" class="btn btn-primary me-2">
            <i class="fas fa-save"></i> ğŸ’¾ Kaydet
        </button>
    </div>
    <div class="col-auto">
        <button id="btn-toggle-camera" class="btn btn-secondary me-2">
            <i class="fas fa-eye"></i> ğŸ‘ï¸ KamerayÄ± Gizle
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global deÄŸiÅŸkenler
    let stream = null;
    let video = document.getElementById('video');
    let capturedImage = null;
    let cameraVisible = true;
    let streamingInterval = null;
    
    // Log alanÄ±na mesaj ekleme
    function addLog(message) {
        const logArea = document.getElementById('log-area');
        const logMessage = document.createElement('div');
        logMessage.textContent = message;
        logArea.appendChild(logMessage);
        logArea.scrollTop = logArea.scrollHeight;
    }
    
    // KamerayÄ± baÅŸlatma
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            video.srcObject = stream;
            video.onloadedmetadata = function() {
                video.play();
                addLog("â–¶ï¸ Kamera baÅŸlatÄ±ldÄ±.");
                
                // Kamera streaming baÅŸladÄ±ÄŸÄ±nda ÅŸifreleme iÅŸlemini baÅŸlat
                startLiveEncryption();
            };
        } catch (err) {
            addLog("âŒ Kamera eriÅŸim hatasÄ±: " + err.message);
            console.error("Kamera eriÅŸim hatasÄ±:", err);
        }
    }
    
    // AnlÄ±k ÅŸifreleme simÃ¼lasyonu
    function startLiveEncryption() {
    const canvas = document.createElement('canvas');
    const encryptedImg = document.getElementById('encrypted-image');
    
    // Her 100ms'de bir ÅŸifrele
    streamingInterval = setInterval(() => {
        if (!video.videoWidth || !cameraVisible) return;
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Canvas gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ blob olarak al
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'live_capture.png');
            
            // Sunucuya ÅŸifreleme iÃ§in gÃ¶nder
            fetch('/live-encrypt', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Base64 ÅŸifreli gÃ¶rÃ¼ntÃ¼yÃ¼ gÃ¶ster
                    const img = new Image();
                    img.onload = () => {
                        encryptedImg.src = img.src;
                    };
                    img.src = 'data:image/png;base64,' + data.encrypted_image;
                }
            })
            .catch(error => {
                console.error('Åifreleme hatasÄ±:', error);
            });
        }, 'image/png');
    }, 100);
}
    // Sayfa yÃ¼klendiÄŸinde kamerayÄ± baÅŸlat
    document.addEventListener('DOMContentLoaded', function() {
        startCamera();
        
        // GÃ¶rÃ¼ntÃ¼ yakalama butonu
        document.getElementById('btn-capture').addEventListener('click', function() {
            if (!cameraVisible) {
                addLog("âš ï¸ Kamera gÃ¶rÃ¼ntÃ¼sÃ¼ gizli. LÃ¼tfen Ã¶nce kamerayÄ± gÃ¶sterin.");
                return;
            }
            
            if (!video.videoWidth) {
                addLog("âš ï¸ Kamera henÃ¼z hazÄ±r deÄŸil. LÃ¼tfen bekleyin.");
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage = canvas.toDataURL('image/png');
            addLog("ğŸ“¸ GÃ¶rÃ¼ntÃ¼ yakalandÄ± ve ÅŸifrelenmeye hazÄ±r.");
        });
        
        // Kaydetme butonu
        document.getElementById('btn-save').addEventListener('click', function() {
            if (!capturedImage) {
                addLog("âš ï¸ Kaydedilecek gÃ¶rÃ¼ntÃ¼ bulunamadÄ±. Ã–nce gÃ¶rÃ¼ntÃ¼ yakalamalÄ±sÄ±nÄ±z.");
                return;
            }
            
            // Canvas'tan blob formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rme
            fetch(capturedImage)
                .then(res => res.blob())
                .then(blob => {
                    const formData = new FormData();
                    formData.append('image', blob, 'capture.png');
                    
                    // Sunucuya gÃ¶rÃ¼ntÃ¼yÃ¼ gÃ¶nderme
                    fetch('/capture', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Sunucunun ÅŸifrelediÄŸi gÃ¶rÃ¼ntÃ¼yÃ¼ yÃ¼kleme
                            document.getElementById('encrypted-image').src = '/static/uploads/' + data.encrypted;
                            addLog(`ğŸ’¾ GÃ¶rÃ¼ntÃ¼ ÅŸifrelendi ve kaydedildi (ID: ${data.id}).`);
                        } else {
                            addLog("âŒ Kaydetme hatasÄ±: " + data.message);
                        }
                    })
                    .catch(error => {
                        addLog("âŒ Sunucu hatasÄ±: " + error);
                        console.error("Sunucu hatasÄ±:", error);
                    });
            });
        });
        
        // KamerayÄ± gizle/gÃ¶ster butonu
        document.getElementById('btn-toggle-camera').addEventListener('click', function() {
            if (cameraVisible) {
                video.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye"></i> ğŸ‘ï¸ KamerayÄ± GÃ¶ster';
                addLog("ğŸ™ˆ Kamera gÃ¶rÃ¼ntÃ¼sÃ¼ gizlendi.");
            } else {
                video.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash"></i> ğŸ‘ï¸ KamerayÄ± Gizle';
                addLog("ğŸ‘ï¸ Kamera gÃ¶rÃ¼ntÃ¼sÃ¼ gÃ¶steriliyor.");
            }
            cameraVisible = !cameraVisible;
        });
    });
    
    // Sayfa kapatÄ±ldÄ±ÄŸÄ±nda kamerayÄ± ve intervali durdur
    window.addEventListener('beforeunload', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (streamingInterval) {
            clearInterval(streamingInterval);
        }
    });
</script>
{% endblock %}